C251 COMPILER V5.60.0,  ICM20602                                                           08/03/24  19:26:53  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE ICM20602
OBJECT MODULE PLACED IN .\Out_flie\ICM20602.obj
COMPILER INVOKED BY: D:\Keil_80251\C251\BIN\C251.EXE ..\LIB\peripheral\ICM20602.c XSMALL INTR2 BROWSE INCDIR(..\LIB\star
                    -tup;..\LIB\libraries;..\LIB\peripheral;..\USER\inc) DEBUG PRINT(.\Listings\ICM20602.lst) TABS(2) OBJECT(.\Out_flie\ICM20
                    -602.obj) 

stmt  level    source

    1          
    2          /********************************************************************************************************
             -*************
    3           * @file          ×ËÌ¬´«¸ÐÆ÷ICM20602
    4           * @date          2024-03-06
    5           * @note    
    6                    ½ÓÏß¶¨Òå£º
    7                    ------------------------------------ 
    8                    ICM20602Ä£¿é(SPIÍ¨ÐÅ)   µ¥Æ¬»ú                        
    9                    SPC                 ²é¿´ICM20602.hÎÄ¼þÖÐµÄICM20602_SPC_PINºê¶¨Òå
   10                    SDI                 ²é¿´ICM20602.hÎÄ¼þÖÐµÄICM20602_SDI_PINºê¶¨Òå
   11                    SDO                 ²é¿´ICM20602.hÎÄ¼þÖÐµÄICM20602_SDO_PINºê¶¨Òå
   12                    CS                  ²é¿´ICM20602.hÎÄ¼þÖÐµÄICM20602_CS_PINºê¶¨Òå
   13                    ------------------------------------ 
   14                    ICM20602Ä£¿é(IICÍ¨ÐÅ)   µ¥Æ¬»ú                        
   15                    SCL                 ²é¿´ICM20602.hÎÄ¼þÖÐµÄICM20602_SCL_PINºê¶¨Òå
   16                    SDA                 ²é¿´ICM20602.hÎÄ¼þÖÐµÄICM20602_SDA_PINºê¶¨Òå
   17                    ------------------------------------ 
   18           ********************************************************************************************************
             -************/
   19          
   20          
   21          #include "ICM20602.h"
   22          
   23          #include "delay.h"
   24          #include "spi.h"
   25          
   26          
   27          #pragma warning disable = 177
   28          #pragma warning disable = 183
   29          
   30          int16 icm20602_gyro_x,icm20602_gyro_y,icm20602_gyro_z;
   31          int16 icm20602_acc_x,icm20602_acc_y,icm20602_acc_z;
   32          
   33          
   34          #if ICM20602_USE_SOFT_IIC
               
               
               #define GET_ICM20602_SDA        ICM20602_SDA_PIN
               #define ICM20602_SDA_LOW()          ICM20602_SDA_PIN = 0    //IO¿ÚÊä³öµÍµçÆ½
               #define ICM20602_SDA_HIGH()         ICM20602_SDA_PIN = 1    //IO¿ÚÊä³ö¸ßµçÆ½
               
               #define ICM20602_SCL_LOW()          ICM20602_SCL_PIN = 0    //IO¿ÚÊä³öµÍµçÆ½
               #define ICM20602_SCL_HIGH()         ICM20602_SCL_PIN = 1    //IO¿ÚÊä³ö¸ßµçÆ½
               
               #define ack 1      //Ö÷Ó¦´ð
               #define no_ack 0   //´ÓÓ¦´ð 
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      Ä£ÄâIICÑÓÊ±
               //  @return     void            
               
               //  Sample usage:       Èç¹ûIICÍ¨Ñ¶Ê§°Ü¿ÉÒÔ³¢ÊÔÔö¼ÓjµÄÖµ
               //-------------------------------------------------------------------------------------------------------
             -------------
               static void icm20602_simiic_delay(void)
C251 COMPILER V5.60.0,  ICM20602                                                           08/03/24  19:26:53  PAGE 2   

               {
                   uint16 j=ICM20602_SOFT_IIC_DELAY;   
                 while(j--);
               }
               
               //ÄÚ²¿Ê¹ÓÃ£¬ÓÃ»§ÎÞÐèµ÷ÓÃ
               static void icm20602_simiic_start(void)
               {
                 ICM20602_SDA_HIGH();
                 ICM20602_SCL_HIGH();
                 icm20602_simiic_delay();
                 ICM20602_SDA_LOW();
                 icm20602_simiic_delay();
                 ICM20602_SCL_LOW();
               }
               
               //ÄÚ²¿Ê¹ÓÃ£¬ÓÃ»§ÎÞÐèµ÷ÓÃ
               static void icm20602_simiic_stop(void)
               {
                 ICM20602_SDA_LOW();
                 ICM20602_SCL_LOW();
                 icm20602_simiic_delay();
                 ICM20602_SCL_HIGH();
                 icm20602_simiic_delay();
                 ICM20602_SDA_HIGH();
                 icm20602_simiic_delay();
               }
               
               //Ö÷Ó¦´ð(°üº¬ack:SDA=0ºÍno_ack:SDA=0)
               //ÄÚ²¿Ê¹ÓÃ£¬ÓÃ»§ÎÞÐèµ÷ÓÃ
               static void icm20602_simiic_sendack(unsigned char ack_dat)
               {
                   ICM20602_SCL_LOW();
                 icm20602_simiic_delay();
                 if(ack_dat) ICM20602_SDA_LOW();
                   else      ICM20602_SDA_HIGH();
               
                   ICM20602_SCL_HIGH();
                   icm20602_simiic_delay();
                   ICM20602_SCL_LOW();
                   icm20602_simiic_delay();
               }
               
               
               static int icm20602_sccb_waitack(void)
               {
                   ICM20602_SCL_LOW();
               
                 icm20602_simiic_delay();
                 
                 ICM20602_SCL_HIGH();
                   icm20602_simiic_delay();
                 
                   if(GET_ICM20602_SDA)           //Ó¦´ðÎª¸ßµçÆ½£¬Òì³££¬Í¨ÐÅÊ§°Ü
                   {
               
                       ICM20602_SCL_LOW();
                       return 0;
                   }
               
                   ICM20602_SCL_LOW();
                 icm20602_simiic_delay();
                   return 1;
               }
               
               //×Ö½Ú·¢ËÍ³ÌÐò
C251 COMPILER V5.60.0,  ICM20602                                                           08/03/24  19:26:53  PAGE 3   

               //·¢ËÍc(¿ÉÒÔÊÇÊý¾ÝÒ²¿ÉÊÇµØÖ·)£¬ËÍÍêºó½ÓÊÕ´ÓÓ¦´ð
               //²»¿¼ÂÇ´ÓÓ¦´ðÎ»
               //ÄÚ²¿Ê¹ÓÃ£¬ÓÃ»§ÎÞÐèµ÷ÓÃ
               static void icm20602_send_ch(uint8 c)
               {
                 uint8 i = 8;
                   while(i--)
                   {
                       if(c & 0x80)  ICM20602_SDA_HIGH();//SDA Êä³öÊý¾Ý
                       else      ICM20602_SDA_LOW();
                       c <<= 1;
                       icm20602_simiic_delay();
                       ICM20602_SCL_HIGH();                //SCL À­¸ß£¬²É¼¯ÐÅºÅ
                       icm20602_simiic_delay();
                       ICM20602_SCL_LOW();                //SCL Ê±ÖÓÏßÀ­µÍ
                   }
                 icm20602_sccb_waitack();
               }
               
               
               //×Ö½Ú½ÓÊÕ³ÌÐò
               //½ÓÊÕÆ÷¼þ´«À´µÄÊý¾Ý£¬´Ë³ÌÐòÓ¦ÅäºÏ|Ö÷Ó¦´ðº¯Êý|Ê¹ÓÃ
               //ÄÚ²¿Ê¹ÓÃ£¬ÓÃ»§ÎÞÐèµ÷ÓÃ
               static uint8 icm20602_read_ch(uint8 ack_x)
               {
                   uint8 i;
                   uint8 c;
                   c=0;
                   ICM20602_SCL_LOW();
                   icm20602_simiic_delay();
                   ICM20602_SDA_HIGH();             
               
                   for(i=0;i<8;i++)
                   {
                       icm20602_simiic_delay();
                       ICM20602_SCL_LOW();         //ÖÃÊ±ÖÓÏßÎªµÍ£¬×¼±¸½ÓÊÕÊý¾ÝÎ»
                       icm20602_simiic_delay();
                       ICM20602_SCL_HIGH();         //ÖÃÊ±ÖÓÏßÎª¸ß£¬Ê¹Êý¾ÝÏßÉÏÊý¾ÝÓÐÐ§
                       icm20602_simiic_delay();
                       c<<=1;
                       if(GET_ICM20602_SDA) 
                       {
                           c+=1;   //¶ÁÊý¾ÝÎ»£¬½«½ÓÊÕµÄÊý¾Ý´æc
                       }
                   }
               
                 ICM20602_SCL_LOW();
                 icm20602_simiic_delay();
                 icm20602_simiic_sendack(ack_x);
                 
                   return c;
               }
               
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      Ä£ÄâIICÐ´Êý¾Ýµ½Éè±¸¼Ä´æÆ÷º¯Êý
               //  @param      dev_add     Éè±¸µØÖ·(µÍÆßÎ»µØÖ·)
               //  @param      reg       ¼Ä´æÆ÷µØÖ·
               //  @param      dat       Ð´ÈëµÄÊý¾Ý
               //  @return     void            
               
               //  Sample usage:       
               //-------------------------------------------------------------------------------------------------------
             -------------
               static void icm20602_simiic_write_reg(uint8 dev_add, uint8 reg, uint8 dat)
C251 COMPILER V5.60.0,  ICM20602                                                           08/03/24  19:26:53  PAGE 4   

               {
                 icm20602_simiic_start();
                   icm20602_send_ch( (dev_add<<1) | 0x00);   //·¢ËÍÆ÷¼þµØÖ·¼ÓÐ´Î»
                 icm20602_send_ch( reg );           //·¢ËÍ´Ó»ú¼Ä´æÆ÷µØÖ·
                 icm20602_send_ch( dat );           //·¢ËÍÐèÒªÐ´ÈëµÄÊý¾Ý
                 icm20602_simiic_stop();
               }
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      Ä£ÄâIIC´ÓÉè±¸¼Ä´æÆ÷¶ÁÈ¡Êý¾Ý
               //  @param      dev_add     Éè±¸µØÖ·(µÍÆßÎ»µØÖ·)
               //  @param      reg       ¼Ä´æÆ÷µØÖ·
               //  @param      type      Ñ¡ÔñÍ¨ÐÅ·½Ê½ÊÇIIC  »¹ÊÇ SCCB
               //  @return     uint8     ·µ»Ø¼Ä´æÆ÷µÄÊý¾Ý      
               
               //  Sample usage:       
               //-------------------------------------------------------------------------------------------------------
             -------------
               static uint8 icm20602_simiic_read_reg(uint8 dev_add, uint8 reg)
               {
                 uint8 dat;
                 icm20602_simiic_start();
                   icm20602_send_ch( (dev_add<<1) | 0x00);  //·¢ËÍÆ÷¼þµØÖ·¼ÓÐ´Î»
                 icm20602_send_ch( reg );          //·¢ËÍ´Ó»ú¼Ä´æÆ÷µØÖ·
               
                 
                 icm20602_simiic_start();
                 icm20602_send_ch( (dev_add<<1) | 0x01);  //·¢ËÍÆ÷¼þµØÖ·¼Ó¶ÁÎ»
                 dat = icm20602_read_ch(no_ack);           //¶ÁÈ¡Êý¾Ý
                 icm20602_simiic_stop();
                 
                 return dat;
               }
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      Ä£ÄâIIC¶ÁÈ¡¶à×Ö½ÚÊý¾Ý
               //  @param      dev_add     Éè±¸µØÖ·(µÍÆßÎ»µØÖ·)
               //  @param      reg       ¼Ä´æÆ÷µØÖ·
               //  @param      dat_add     Êý¾Ý±£´æµÄµØÖ·Ö¸Õë
               //  @param      num       ¶ÁÈ¡×Ö½ÚÊýÁ¿
               //  @param      type      Ñ¡ÔñÍ¨ÐÅ·½Ê½ÊÇIIC  »¹ÊÇ SCCB
               //  @return     uint8     ·µ»Ø¼Ä´æÆ÷µÄÊý¾Ý      
               
               //  Sample usage:       
               //-------------------------------------------------------------------------------------------------------
             -------------
               static void icm20602_simiic_read_regs(uint8 dev_add, uint8 reg, uint8 *dat_add, uint32 num)
               {
                 icm20602_simiic_start();
                   icm20602_send_ch( (dev_add<<1) | 0x00);  //·¢ËÍÆ÷¼þµØÖ·¼ÓÐ´Î»
                 icm20602_send_ch( reg );          //·¢ËÍ´Ó»ú¼Ä´æÆ÷µØÖ·
               
                 
                 icm20602_simiic_start();
                 icm20602_send_ch( (dev_add<<1) | 0x01);  //·¢ËÍÆ÷¼þµØÖ·¼Ó¶ÁÎ»
                   while(--num)
                   {
                       *dat_add = icm20602_read_ch(ack); //¶ÁÈ¡Êý¾Ý
                       dat_add++;
                   }
                   *dat_add = icm20602_read_ch(no_ack); //¶ÁÈ¡Êý¾Ý
                 icm20602_simiic_stop();
               }
               
C251 COMPILER V5.60.0,  ICM20602                                                           08/03/24  19:26:53  PAGE 5   

               #define icm20602_write_register(reg, dat)        (icm20602_simiic_write_reg(ICM20602_DEV_ADDR, (reg), (da
             -t)))
               #define icm20602_write_registers(reg, dat, len)  (icm20602_simiic_write_regs(ICM20602_DEV_ADDR, (reg), (d
             -at), (len)))
               #define icm20602_read_register(reg)              (icm20602_simiic_read_reg(ICM20602_DEV_ADDR, (reg)))
               #define icm20602_read_registers(reg, dat, len)   (icm20602_simiic_read_regs(ICM20602_DEV_ADDR, (reg), (da
             -t), (len)))
               
               #else
  252          
  253          #define ICM20602_SCK(x)       ICM20602_SPC_PIN  = x
  254          #define ICM20602_MOSI(x)      ICM20602_SDI_PIN = x
  255          #define ICM20602_CS(x)        ICM20602_CS_PIN  = x
  256          #define ICM20602_MISO         ICM20602_SDO_PIN 
  257          
  258          //-------------------------------------------------------------------------------------------------------
             -------------
  259          //  @brief      Í¨¹ýSPIÐ´Ò»¸öbyte,Í¬Ê±¶ÁÈ¡Ò»¸öbyte
  260          //  @param      byte        ·¢ËÍµÄÊý¾Ý    
  261          //  @return     uint8       return ·µ»Østatus×´Ì¬
  262          
  263          //  Sample usage:
  264          //-------------------------------------------------------------------------------------------------------
             -------------
  265          static uint8 icm20602_simspi_wr_byte(uint8 byte)
  266          {
  267   1          uint8 i;
  268   1        
  269   1          for(i=0; i<8; i++)
  270   1          {
  271   2              ICM20602_MOSI(byte&0x80);
  272   2              byte <<= 1;
  273   2          ICM20602_SCK (0);
  274   2          ICM20602_SCK (0);
  275   2          
  276   2          ICM20602_SCK (1);
  277   2          ICM20602_SCK (1);
  278   2          byte |= ICM20602_MISO; 
  279   2          } 
  280   1          return(byte);                                         
  281   1      }
  282          //-------------------------------------------------------------------------------------------------------
             -------------
  283          //  @brief      ½«valÐ´Èëcmd¶ÔÓ¦µÄ¼Ä´æÆ÷µØÖ·,Í¬Ê±·µ»Østatus×Ö½Ú
  284          //  @param      cmd         ÃüÁî×Ö
  285          //  @param      val         ´ýÐ´Èë¼Ä´æÆ÷µÄÊýÖµ
  286          
  287          //  Sample usage:
  288          //-------------------------------------------------------------------------------------------------------
             -------------
  289          static void icm20602_simspi_w_reg_byte(uint8 cmd, uint8 val)
  290          {
  291   1      
  292   1          cmd |= ICM20602_SPI_W;
  293   1          icm20602_simspi_wr_byte(cmd);                       
  294   1          icm20602_simspi_wr_byte(val);                                 
  295   1                                        
  296   1      }
  297          
  298          
  299          //-------------------------------------------------------------------------------------------------------
             -------------
  300          //  @brief      ½«valÐ´Èëcmd¶ÔÓ¦µÄ¼Ä´æÆ÷µØÖ·
  301          //  @param      cmd         ÃüÁî×Ö
  302          //  @param      val         ´ýÐ´Èë¼Ä´æÆ÷µÄÊýÖµ
  303          
C251 COMPILER V5.60.0,  ICM20602                                                           08/03/24  19:26:53  PAGE 6   

  304          //  Sample usage:
  305          //-------------------------------------------------------------------------------------------------------
             -------------
  306          //static void icm20602_simspi_w_reg_bytes(uint8 cmd, uint8 *dat_addr, uint32 len)
  307          //{
  308          
  309          //  
  310          //    ICM20602_CS(0);
  311          //    cmd |= ICM20602_SPI_W;
  312          //    icm20602_simspi_wr_byte(cmd);   
  313          //  while(len--)
  314          //  {
  315          //    icm20602_simspi_wr_byte(*dat_addr++); 
  316          //  }                 
  317          //    ICM20602_CS(1);                                     
  318          //}
  319          
  320          //-------------------------------------------------------------------------------------------------------
             -------------
  321          //  @brief      ¶ÁÈ¡cmdËù¶ÔÓ¦µÄ¼Ä´æÆ÷µØÖ·
  322          //  @param      cmd         ÃüÁî×Ö
  323          //  @param      *val        ´æ´¢¶ÁÈ¡µÄÊý¾ÝµØÖ·
  324          
  325          //  Sample usage:
  326          //-------------------------------------------------------------------------------------------------------
             -------------
  327          static void icm20602_simspi_r_reg_byte(uint8 cmd, uint8 *val)
  328          {
  329   1      
  330   1          cmd |= ICM20602_SPI_R;
  331   1          icm20602_simspi_wr_byte(cmd);                                 
  332   1          *val = icm20602_simspi_wr_byte(0);                            
  333   1                                      
  334   1      }
  335          
  336          //-------------------------------------------------------------------------------------------------------
             -------------
  337          //  @brief      ¶ÁÈ¡cmdËù¶ÔÓ¦µÄ¼Ä´æÆ÷µØÖ·
  338          //  @param      cmd         ÃüÁî×Ö
  339          //  @param      *val        ´æ´¢¶ÁÈ¡µÄÊý¾ÝµØÖ·
  340          //  @param      num         ¶ÁÈ¡µÄÊýÁ¿
  341          
  342          //  Sample usage:
  343          //-------------------------------------------------------------------------------------------------------
             -------------
  344          static void icm20602_simspi_r_reg_bytes(uint8 cmd, uint8 *val, uint32 num)
  345          {
  346   1          uint32 i = 0;
  347   1          cmd |= ICM20602_SPI_R;
  348   1          icm20602_simspi_wr_byte(cmd);
  349   1      
  350   1        while(num--)
  351   1        {
  352   2          *val++ = icm20602_simspi_wr_byte(0);
  353   2        }          
  354   1      }
  355          
  356          
  357          //-------------------------------------------------------------------------------------------------------
             -------------
  358          // º¯Êý¼ò½é     IMU660RA Ð´¼Ä´æÆ÷
  359          // ²ÎÊýËµÃ÷     reg             ¼Ä´æÆ÷µØÖ·
  360          // ²ÎÊýËµÃ÷     dat            Êý¾Ý
  361          // ·µ»Ø²ÎÊý     void
  362          // Ê¹ÓÃÊ¾Àý     icm20602_write_register(ICM20602_PWR_CONF, 0x00);                   // ¹Ø±Õ¸ß¼¶Ê¡µçÄ£Ê½
  363          // ±¸×¢ÐÅÏ¢     ÄÚ²¿µ÷ÓÃ
C251 COMPILER V5.60.0,  ICM20602                                                           08/03/24  19:26:53  PAGE 7   

  364          //-------------------------------------------------------------------------------------------------------
             -------------
  365          static void icm20602_write_register(uint8 reg, uint8 dat)
  366          {
  367   1          ICM20602_CS(0);
  368   1          icm20602_simspi_w_reg_byte(reg | ICM20602_SPI_W, dat);
  369   1          ICM20602_CS(1);
  370   1      }
  371          
  372          //-------------------------------------------------------------------------------------------------------
             -------------
  373          // º¯Êý¼ò½é     IMU660RA Ð´Êý¾Ý
  374          // ²ÎÊýËµÃ÷     reg             ¼Ä´æÆ÷µØÖ·
  375          // ²ÎÊýËµÃ÷     dat            Êý¾Ý
  376          // ·µ»Ø²ÎÊý     void
  377          // Ê¹ÓÃÊ¾Àý     icm20602_write_registers(ICM20602_INIT_dat, icm20602_config_file, sizeof(icm20602_config_
             -file));
  378          // ±¸×¢ÐÅÏ¢     ÄÚ²¿µ÷ÓÃ
  379          //-------------------------------------------------------------------------------------------------------
             -------------
  380          //static void icm20602_write_registers(uint8 reg, const uint8 *dat, uint32 len)
  381          //{
  382          //    ICM20602_CS(0);
  383          //    icm20602_simspi_w_reg_bytes(reg | ICM20602_SPI_W, dat, len);
  384          //    ICM20602_CS(1);
  385          //}
  386          
  387          //-------------------------------------------------------------------------------------------------------
             -------------
  388          // º¯Êý¼ò½é     IMU660RA ¶Á¼Ä´æÆ÷
  389          // ²ÎÊýËµÃ÷     reg             ¼Ä´æÆ÷µØÖ·
  390          // ·µ»Ø²ÎÊý     uint8           Êý¾Ý
  391          // Ê¹ÓÃÊ¾Àý     icm20602_read_register(ICM20602_CHIP_ID);
  392          // ±¸×¢ÐÅÏ¢     ÄÚ²¿µ÷ÓÃ
  393          //-------------------------------------------------------------------------------------------------------
             -------------
  394          static uint8 icm20602_read_register(uint8 reg)
  395          {
  396   1          uint8 dat;
  397   1          ICM20602_CS(0);
  398   1          icm20602_simspi_r_reg_byte(reg | ICM20602_SPI_R, &dat);
  399   1          ICM20602_CS(1);
  400   1          return dat;
  401   1      }
  402          
  403          //-------------------------------------------------------------------------------------------------------
             -------------
  404          // º¯Êý¼ò½é     IMU660RA ¶ÁÊý¾Ý
  405          // ²ÎÊýËµÃ÷     reg             ¼Ä´æÆ÷µØÖ·
  406          // ²ÎÊýËµÃ÷     dat            Êý¾Ý»º³åÇø
  407          // ²ÎÊýËµÃ÷     len             Êý¾Ý³¤¶È
  408          // ·µ»Ø²ÎÊý     void
  409          // Ê¹ÓÃÊ¾Àý     icm20602_read_registers(ICM20602_ACC_ADDRESS, dat, 6);
  410          // ±¸×¢ÐÅÏ¢     ÄÚ²¿µ÷ÓÃ
  411          //-------------------------------------------------------------------------------------------------------
             -------------
  412          static void icm20602_read_registers(uint8 reg, uint8 *dat, uint32 len)
  413          {
  414   1          ICM20602_CS(0);
  415   1          icm20602_simspi_r_reg_bytes(reg | ICM20602_SPI_R, dat, len);
  416   1        ICM20602_CS(1);
  417   1      }
  418          
  419          
  420          #endif
  421          
C251 COMPILER V5.60.0,  ICM20602                                                           08/03/24  19:26:53  PAGE 8   

  422          //-------------------------------------------------------------------------------------------------------
             -------------
  423          // º¯Êý¼ò½é     ICM20602 ×Ô¼ì
  424          // ²ÎÊýËµÃ÷     void
  425          // ·µ»Ø²ÎÊý     uint8           1-×Ô¼ìÊ§°Ü 0-×Ô¼ì³É¹¦
  426          // Ê¹ÓÃÊ¾Àý     icm20602_self_check();
  427          // ±¸×¢ÐÅÏ¢     ÄÚ²¿µ÷ÓÃ
  428          //-------------------------------------------------------------------------------------------------------
             -------------
  429          static uint8 icm20602_self_check (void)
  430          {
  431   1          uint8 dat = 0, return_state = 0;
  432   1          uint16 timeout_count = 0;
  433   1      
  434   1          while(0x12 != dat)                                                          // ÅÐ¶Ï ID ÊÇ·ñÕýÈ·
  435   1          {
  436   2              if(timeout_count ++ > ICM20602_TIMEOUT_COUNT)
  437   2              {
  438   3                  return_state =  1;
  439   3                  break;
  440   3              }
  441   2              dat = icm20602_read_register(ICM20602_WHO_AM_I);
  442   2      
  443   2              delay_ms(10);
  444   2          }
  445   1          return return_state;
  446   1      }
  447          
  448          //-------------------------------------------------------------------------------------------------------
             -------------
  449          // º¯Êý¼ò½é     »ñÈ¡ ICM20602 ¼ÓËÙ¶È¼ÆÊý¾Ý
  450          // ²ÎÊýËµÃ÷     void
  451          // ·µ»Ø²ÎÊý     void
  452          // Ê¹ÓÃÊ¾Àý     icm20602_get_acc();                                             // Ö´ÐÐ¸Ãº¯Êýºó£¬Ö±½Ó²é¿´
             -¶ÔÓ¦µÄ±äÁ¿¼´¿É
  453          // ±¸×¢ÐÅÏ¢
  454          //-------------------------------------------------------------------------------------------------------
             -------------
  455          void icm20602_get_acc (void)
  456          {
  457   1          uint8 dat[6];
  458   1      
  459   1          icm20602_read_registers(ICM20602_ACCEL_XOUT_H, dat, 6);
  460   1          icm20602_acc_x = (int16)(((uint16)dat[0] << 8 | dat[1]));
  461   1          icm20602_acc_y = (int16)(((uint16)dat[2] << 8 | dat[3]));
  462   1          icm20602_acc_z = (int16)(((uint16)dat[4] << 8 | dat[5]));
  463   1      }
  464          
  465          //-------------------------------------------------------------------------------------------------------
             -------------
  466          // º¯Êý¼ò½é     »ñÈ¡ICM20602ÍÓÂÝÒÇÊý¾Ý
  467          // ²ÎÊýËµÃ÷     void
  468          // ·µ»Ø²ÎÊý     void
  469          // Ê¹ÓÃÊ¾Àý     icm20602_get_gyro();                                            // Ö´ÐÐ¸Ãº¯Êýºó£¬Ö±½Ó²é¿´
             -¶ÔÓ¦µÄ±äÁ¿¼´¿É
  470          // ±¸×¢ÐÅÏ¢
  471          //-------------------------------------------------------------------------------------------------------
             -------------
  472          void icm20602_get_gyro (void)
  473          {
  474   1          uint8 dat[6];
  475   1      
  476   1          icm20602_read_registers(ICM20602_GYRO_XOUT_H, dat, 6);
  477   1          icm20602_gyro_x = (int16)(((uint16)dat[0] << 8 | dat[1]));
  478   1          icm20602_gyro_y = (int16)(((uint16)dat[2] << 8 | dat[3]));
  479   1          icm20602_gyro_z = (int16)(((uint16)dat[4] << 8 | dat[5]));
C251 COMPILER V5.60.0,  ICM20602                                                           08/03/24  19:26:53  PAGE 9   

  480   1      }
  481          
  482          //-------------------------------------------------------------------------------------------------------
             -------------
  483          // º¯Êý¼ò½é     ½« ICM20602 ¼ÓËÙ¶È¼ÆÊý¾Ý×ª»»ÎªÊµ¼ÊÎïÀíÊý¾Ý
  484          // ²ÎÊýËµÃ÷     gyro_value      ÈÎÒâÖáµÄ¼ÓËÙ¶È¼ÆÊý¾Ý
  485          // ·µ»Ø²ÎÊý     void
  486          // Ê¹ÓÃÊ¾Àý     float data = icm20602_acc_transition(icm20602_acc_x);           // µ¥Î»Îª g(m/s^2)
  487          // ±¸×¢ÐÅÏ¢
  488          //-------------------------------------------------------------------------------------------------------
             -------------
  489          float icm20602_acc_transition (int16 acc_value)
  490          {
  491   1          float acc_data = 0;
  492   1          switch(ICM20602_ACC_SAMPLE)
  493   1          {
  494   2              case 0x00: acc_data = (float)acc_value / 16384; break;                  // 0x00 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À
             -2g     »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ 16384      ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  495   2              case 0x08: acc_data = (float)acc_value / 8192;  break;                  // 0x08 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À
             -4g     »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ 8192       ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  496   2              case 0x10: acc_data = (float)acc_value / 4096;  break;                  // 0x10 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À
             -8g     »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ 4096       ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  497   2              case 0x18: acc_data = (float)acc_value / 2048;  break;                  // 0x18 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À
             -16g    »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ 2048       ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  498   2              default: break;
  499   2          }
  500   1          return acc_data;
  501   1      }
  502          
  503          //-------------------------------------------------------------------------------------------------------
             -------------
  504          // º¯Êý¼ò½é     ½« ICM20602 ÍÓÂÝÒÇÊý¾Ý×ª»»ÎªÊµ¼ÊÎïÀíÊý¾Ý
  505          // ²ÎÊýËµÃ÷     gyro_value      ÈÎÒâÖáµÄÍÓÂÝÒÇÊý¾Ý
  506          // ·µ»Ø²ÎÊý     void
  507          // Ê¹ÓÃÊ¾Àý     float data = icm20602_gyro_transition(icm20602_gyro_x);         // µ¥Î»Îª¡ã/s
  508          // ±¸×¢ÐÅÏ¢
  509          //-------------------------------------------------------------------------------------------------------
             -------------
  510          float icm20602_gyro_transition (int16 gyro_value)
  511          {
  512   1          float gyro_data = 0;
  513   1          switch(ICM20602_GYR_SAMPLE)
  514   1          {
  515   2              case 0x00: gyro_data = (float)gyro_value / 131.0f;  break;              // 0x00 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À25
             -0 dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ 131           ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  516   2              case 0x08: gyro_data = (float)gyro_value / 65.5f;   break;              // 0x08 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À50
             -0 dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ 65.5          ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  517   2              case 0x10: gyro_data = (float)gyro_value / 32.8f;   break;              // 0x10 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À10
             -00dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ 32.8          ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  518   2              case 0x18: gyro_data = (float)gyro_value / 16.4f;   break;              // 0x18 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À20
             -00dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ 16.4          ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  519   2              default: break;
  520   2          }
  521   1          return gyro_data;
  522   1      }
  523          
  524          //-------------------------------------------------------------------------------------------------------
             -------------
  525          // º¯Êý¼ò½é     ³õÊ¼»¯ ICM20602
  526          // ²ÎÊýËµÃ÷     void
  527          // ·µ»Ø²ÎÊý     uint8           1-³õÊ¼»¯Ê§°Ü 0-³õÊ¼»¯³É¹¦
  528          // Ê¹ÓÃÊ¾Àý     icm20602_init();
  529          // ±¸×¢ÐÅÏ¢
  530          //-------------------------------------------------------------------------------------------------------
             -------------
  531          uint8 icm20602_init (void)
C251 COMPILER V5.60.0,  ICM20602                                                           08/03/24  19:26:53  PAGE 10  

  532          {
  533   1          uint8 val = 0x0, return_state = 0;
  534   1          uint16 timeout_count = 0;
  535   1      
  536   1          delay_ms(10);                                                        // ÉÏµçÑÓÊ±
  537   1      
  538   1      //#if ICM20602_USE_SOFT_IIC
  539   1      //    soft_iic_init(&icm20602_iic_struct, ICM20602_DEV_ADDR, ICM20602_SOFT_IIC_DELAY, ICM20602_SCL_PIN, I
             -CM20602_SDA_PIN);
  540   1      //#else
  541   1      //    spi_init(ICM20602_SPI, SPI_MODE0, ICM20602_SPI_SPEED, ICM20602_SPC_PIN, ICM20602_SDI_PIN, ICM20602_
             -SDO_PIN, SPI_CS_NULL);
  542   1      //    gpio_init(ICM20602_CS_PIN, GPO, GPIO_HIGH, GPO_PUSH_PULL);
  543   1      //#endif
  544   1      
  545   1          do
  546   1          {
  547   2              if(icm20602_self_check())
  548   2              {
  549   3                  // Èç¹û³ÌÐòÔÚÊä³öÁË¶ÏÑÔÐÅÏ¢ ²¢ÇÒÌáÊ¾³ö´íÎ»ÖÃÔÚÕâÀï
  550   3                  // ÄÇÃ´¾ÍÊÇ ICM20602 ×Ô¼ì³ö´í²¢³¬Ê±ÍË³öÁË
  551   3                  // ¼ì²éÒ»ÏÂ½ÓÏßÓÐÃ»ÓÐÎÊÌâ Èç¹ûÃ»ÎÊÌâ¿ÉÄÜ¾ÍÊÇ»µÁË
  552   3                  
  553   3      //      while(1)
  554   3      //      {
  555   3              printf("icm20602 self check error.\r\n");
  556   3      //        delay_ms(200);
  557   3      //      }
  558   3                  return_state = 1;
  559   3                  break;
  560   3              }
  561   2      
  562   2              icm20602_write_register(ICM20602_PWR_MGMT_1, 0x80);                     // ¸´Î»Éè±¸
  563   2              delay_ms(2);
  564   2      
  565   2              do
  566   2              {                                                                       // µÈ´ý¸´Î»³É¹¦
  567   3                  val = icm20602_read_register(ICM20602_PWR_MGMT_1);
  568   3                  if(timeout_count ++ > ICM20602_TIMEOUT_COUNT)
  569   3                  {
  570   4                      // Èç¹û³ÌÐòÔÚÊä³öÁË¶ÏÑÔÐÅÏ¢ ²¢ÇÒÌáÊ¾³ö´íÎ»ÖÃÔÚÕâÀï
  571   4                      // ÄÇÃ´¾ÍÊÇ ICM20602 ×Ô¼ì³ö´í²¢³¬Ê±ÍË³öÁË
  572   4                      // ¼ì²éÒ»ÏÂ½ÓÏßÓÐÃ»ÓÐÎÊÌâ Èç¹ûÃ»ÎÊÌâ¿ÉÄÜ¾ÍÊÇ»µÁË
  573   4      //        while(1)
  574   4      //        {
  575   4                printf("icm20602 reset error.\r\n");
  576   4      //          delay_ms(200);
  577   4      //        }
  578   4                      return_state = 1;
  579   4                      break;
  580   4                  }
  581   3              }while(0x41 != val);
  582   2              if(1 == return_state)
  583   2              {
  584   3                  break;
  585   3              }
  586   2      
  587   2              icm20602_write_register(ICM20602_PWR_MGMT_1,     0x01);                 // Ê±ÖÓÉèÖÃ
  588   2              icm20602_write_register(ICM20602_PWR_MGMT_2,     0x00);                 // ¿ªÆôÍÓÂÝÒÇºÍ¼ÓËÙ¶È¼Æ
  589   2              icm20602_write_register(ICM20602_CONFIG,         0x01);                 // 176HZ 1KHZ
  590   2              icm20602_write_register(ICM20602_SMPLRT_DIV,     0x07);                 // ²ÉÑùËÙÂÊ SAMPLE_RATE =
             - INTERNAL_SAMPLE_RATE / (1 + SMPLRT_DIV)
  591   2              
  592   2          icm20602_write_register(ICM20602_GYRO_CONFIG,    ICM20602_GYR_SAMPLE);  // ¡À2000 dps
  593   2          // ICM20602_GYRO_CONFIG¼Ä´æÆ÷
  594   2              // ÉèÖÃÎª:0x00 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À250 dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ131           ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î
C251 COMPILER V5.60.0,  ICM20602                                                           08/03/24  19:26:53  PAGE 11  

             -»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  595   2              // ÉèÖÃÎª:0x08 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À500 dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ65.5          ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î
             -»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  596   2              // ÉèÖÃÎª:0x10 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À1000dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ32.8          ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î
             -»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  597   2              // ÉèÖÃÎª:0x18 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À2000dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ16.4          ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î
             -»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  598   2              
  599   2          icm20602_write_register(ICM20602_ACCEL_CONFIG,   ICM20602_ACC_SAMPLE);  // ¡À8g
  600   2          // ICM20602_ACCEL_CONFIG¼Ä´æÆ÷
  601   2              // ÉèÖÃÎª:0x00 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À2g          »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ16384      ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ
             -¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  602   2              // ÉèÖÃÎª:0x08 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À4g          »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ8192       ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ
             -¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  603   2              // ÉèÖÃÎª:0x10 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À8g          »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ4096       ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ
             -¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  604   2              // ÉèÖÃÎª:0x18 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À16g         »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ2048       ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ
             -¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  605   2             
  606   2          icm20602_write_register(ICM20602_ACCEL_CONFIG_2, 0x03);                 // Average 4 samples   44.8HZ  
             - //0x23 Average 16 samples
  607   2      
  608   2      
  609   2          }while(0);
  610   1          return return_state;
  611   1      }
  612          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       523     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =        12         17
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        53     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
